<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Proposal üíç</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
/* --- RESET & BASE --- */
* { margin:0; padding:0; box-sizing:border-box; }
body {
  overflow:hidden;
  background: radial-gradient(circle, #120018, #000);
  font-family: system-ui, sans-serif;
}

/* CANVAS */
canvas { position:fixed; inset:0; }

/* MAIN TEXT */
#text {
  position:absolute;
  top:38%;
  left:50%;
  transform:translate(-50%, -50%);
  font-family: cursive;
  font-size:clamp(1.8rem, 7vw, 4.8rem);
  color:white;
  text-align:center;
  letter-spacing:clamp(0.08rem,0.8vw,0.3rem);
  text-shadow:0 0 10px pink, 0 0 40px hotpink;
  white-space:pre-line;
  width:90%;
  max-width:900px;
  z-index:5;
}

#heart {
  position:absolute;
  top:58%;
  left:50%;
  transform:translate(-50%, -50%);
  font-size:clamp(2rem,6vw,3rem);
  opacity:0;
  animation:pulse 1.5s infinite;
}

@keyframes pulse {
  50% { transform:translate(-50%, -50%) scale(1.2); }
}

/* BUTTON */
#storyBtn {
  position:absolute;
  top:70%;
  left:50%;
  transform:translate(-50%, -50%);
  padding:clamp(10px,3vw,14px) clamp(22px,6vw,30px);
  border-radius:30px;
  border:none;
  background:linear-gradient(45deg, hotpink, red);
  color:white;
  font-size:clamp(0.9rem,3.5vw,1rem);
  cursor:pointer;
  opacity:0;
  transition:opacity 0.5s ease;
}

/* POPUP */
#popup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
  padding:20px;
}

#popupContent {
  background:#1a001f;
  color:#fff;
  max-width:600px;
  width:100%;
  border-radius:20px;
  padding:25px;
  text-align:center;
  box-shadow:0 0 30px hotpink;
  display:flex;
  flex-direction:column;
  overflow:visible;
}

/* HEADING */
#popupContent h2 {
  font-family:'Great Vibes', cursive;
  font-size:clamp(2rem,6vw,2.8rem);
  color:pink;
  margin-bottom:10px;
}

/* POPUP TEXT - WITH SCROLLBAR FOR LONG MESSAGE ONLY */
#popupText {
  font-size:clamp(0.95rem,1.1vw,1.1rem);
  line-height:1.6;
  white-space:pre-line;
  margin-bottom:15px;
  /* Default: no scroll */
  overflow-y: visible;
  max-height:none;
  text-align: center;
  transition: all 0.3s ease;
}

/* Long message specific styles */
.long-message {
  overflow-y: auto !important;
  max-height: 300px !important;
  text-align: left !important;
  padding-right: 10px !important;
}

/* Scrollbar styling */
.long-message::-webkit-scrollbar {
  width: 8px;
}

.long-message::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

.long-message::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, hotpink, pink);
  border-radius: 10px;
}

.long-message::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #ff1493, #ff69b4);
}

/* SINGLE HEART & IMAGE */
#heartWrap {
  position:relative;
  width:clamp(180px,60vw,240px);
  height:clamp(160px,55vw,220px);
  margin:20px auto;
  display:none;
}

#singleHeart {
  width:100%;
  height:100%;
  fill:url(#grad);
  filter:
    drop-shadow(0 0 15px hotpink)
    drop-shadow(0 0 35px rgba(255,20,147,0.8))
    drop-shadow(0 0 60px rgba(255,0,0,0.6));
  animation:heartBeat 1.6s infinite;
}

@keyframes heartBeat {
  0%,100% { transform:scale(1); }
  50% { transform:scale(1.08); }
}

#proposalImg {
  position:absolute;
  top:55px;
  left:50%;
  transform:translateX(-50%);
  width:clamp(80px,30vw,110px);
  border-radius:14px;
  z-index:2;
}

/* RING */
#ring {
  font-size:clamp(3rem,10vw,4rem);
  margin:15px 0;
  opacity:0;
  display:none;
  animation:ringDrop 1.5s ease forwards;
}

@keyframes ringDrop {
  0% { transform:translateY(-40px) scale(0); opacity:0; }
  60% { transform:translateY(10px) scale(1.2); opacity:1; }
  100% { transform:translateY(0) scale(1); opacity:1; }
}

/* VIDEO PLAYER - UPDATED STYLES */
#proposalVideoContainer {
  display: none;
  margin: 20px auto;
  width: clamp(250px, 80vw, 450px);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 0 25px rgba(255, 20, 147, 0.7);
  position: relative;
}

#proposalVideo {
  width: 100%;
  height: auto;
  display: block;
  background: #000;
}

/* Video controls */
.video-controls {
  background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
  padding: 15px 10px 10px;
  position: absolute;
  bottom: 0;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 8px;
  transition: opacity 0.3s;
}

.controls-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

/* Progress bar */
.progress-container {
  flex: 1;
  height: 6px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  overflow: hidden;
  cursor: pointer;
  margin: 0 5px;
}

#videoProgress {
  width: 0%;
  height: 100%;
  background: linear-gradient(to right, hotpink, gold);
  border-radius: 3px;
  transition: width 0.1s;
  position: relative;
}

#videoProgress::after {
  content: '';
  position: absolute;
  right: -5px;
  top: 50%;
  transform: translateY(-50%);
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 0 8px hotpink;
  display: none;
}

.progress-container:hover #videoProgress::after {
  display: block;
}

/* Control buttons */
.control-btn {
  background: rgba(255, 20, 147, 0.8);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 18px;
  box-shadow: 0 0 10px rgba(255, 20, 147, 0.5);
}

.control-btn:hover {
  background: rgba(255, 20, 147, 1);
  transform: scale(1.1);
  box-shadow: 0 0 15px hotpink;
}

.control-btn i {
  font-size: 18px;
}

.time-display {
  color: white;
  font-size: 14px;
  font-family: monospace;
  min-width: 100px;
  text-align: center;
  text-shadow: 0 0 5px rgba(0,0,0,0.8);
  background: rgba(0,0,0,0.5);
  padding: 4px 8px;
  border-radius: 4px;
}

/* Volume controls */
.volume-control {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-left: 5px;
}

.volume-slider {
  width: 70px;
  height: 4px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.volume-slider-fill {
  height: 100%;
  width: 80%;
  background: linear-gradient(to right, pink, hotpink);
  border-radius: 2px;
}

.volume-slider-handle {
  position: absolute;
  right: 20%;
  top: 50%;
  transform: translate(50%, -50%);
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 0 5px hotpink;
  display: none;
}

.volume-slider:hover .volume-slider-handle {
  display: block;
}

/* Continue button below video */
#continueAfterVideo {
  margin: 20px auto 0;
  padding: 12px 30px;
  border: none;
  border-radius: 25px;
  background: linear-gradient(45deg, #ff1493, #ff6b9d);
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: not-allowed;
  display: none;
  opacity: 0.6;
  transition: all 0.3s;
  box-shadow: 0 0 15px rgba(255, 20, 147, 0.3);
  position: relative;
  overflow: hidden;
}

#continueAfterVideo::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

#continueAfterVideo.enabled {
  opacity: 1;
  cursor: pointer;
  box-shadow: 0 0 25px hotpink;
  background: linear-gradient(45deg, hotpink, #ff3366);
  animation: pulseButton 2s infinite;
}

@keyframes pulseButton {
  0%, 100% { box-shadow: 0 0 25px hotpink; }
  50% { box-shadow: 0 0 35px hotpink, 0 0 45px rgba(255, 20, 147, 0.5); }
}

#continueAfterVideo.enabled:hover {
  transform: scale(1.05);
  box-shadow: 0 0 30px hotpink;
}

#continueAfterVideo.enabled:hover::before {
  left: 100%;
}

#continueAfterVideo i {
  margin-right: 8px;
}

/* BUTTON CLOSE */
#closeBtn {
  margin-top:20px;
  padding:12px 28px;
  border:none;
  border-radius:25px;
  background:linear-gradient(45deg, gold, hotpink);
  color:#fff;
  font-size:1rem;
  cursor:pointer;
  box-shadow:0 0 15px gold;
}

/* CELEBRATION SCREEN */
#celebrationScreen {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:1000;
  text-align:center;
  padding:20px;
}

.celebrationContent {
  background:linear-gradient(135deg, #1a001f, #2a003f);
  border-radius:20px;
  padding:40px 30px;
  max-width:600px;
  width:90%;
  box-shadow:0 0 50px hotpink, 0 0 100px rgba(255,20,147,0.5);
  animation:celebrateAppear 1s ease-out;
}

@keyframes celebrateAppear {
  0% { transform:scale(0.8); opacity:0; }
  100% { transform:scale(1); opacity:1; }
}

/* MOBILE TUNING */
@media(max-width:480px){
  #text { top:36%; }
  #heart { top:56%; }
  #storyBtn { top:74%; }
  #popupContent { padding:15px; }
  #popupText { font-size:0.95rem; line-height:1.5; }
  .celebrationContent { padding:30px 20px; }
  .video-controls { padding: 10px 8px 8px; }
  .control-btn { width: 36px; height: 36px; }
  .control-btn i { font-size: 16px; }
  .time-display { min-width: 80px; font-size: 12px; }
  .volume-slider { width: 50px; }
  #continueAfterVideo { padding: 10px 20px; font-size: 1rem; }
}

/* FINAL MESSAGE STYLES */
.final-message-overlay {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2000;
}

.final-message-content {
  background:rgba(26,0,31,0.95);
  color:white;
  padding:30px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 0 50px hotpink;
  max-width:500px;
  width:90%;
}

.final-message-content h2 {
  font-family:'Great Vibes', cursive;
  font-size:2.5rem;
  color:gold;
  margin-bottom:20px;
}

.final-message-content p {
  margin-bottom:25px;
  line-height:1.6;
}

.call-button {
  display:inline-block;
  padding:12px 30px;
  border:none;
  border-radius:20px;
  background:linear-gradient(45deg, hotpink, red);
  color:white;
  cursor:pointer;
  font-size:1.1rem;
  text-decoration:none;
  margin-top:10px;
  transition:transform 0.3s, box-shadow 0.3s;
}

.call-button:hover {
  transform:scale(1.05);
  box-shadow:0 0 20px hotpink;
}
</style>
</head>

<body>

<canvas></canvas>

<div id="text"></div>
<div id="heart"></div>
<button id="storyBtn">üíñ Read Our Journey</button>

<div id="popup">
  <div id="popupContent">
    <h2 id="popupHeading">Our Journey</h2>
    <div id="popupText">
      Ek auto ka chhota sa safar,
      aur tumhare diye hue 10 rupaye ‚Äî
      jo aaj bhi mere paas hain,
      kyunki unmein tumhari parwah basi hai.

      Phir baatein badhti gayi,
      safar lambi hote gaye,
      aur pyaar dheere-dheere gehra hota gaya.

      Mumbai ne thoda faasla zaroor laaya,
      meri galtiyon se kuch khamoshiyan bhi aayi‚Ä¶
      lekin samajh, sabr aur sacche pyaar ne
      humein phir se aur zyada kareeb la diya.

      Aaj hum saath hain ‚Äî
      kam lafzon mein,
      par gehre pyaar ke saath ‚ù§Ô∏è
    </div>

    <div id="heartWrap">
      <svg id="singleHeart" viewBox="0 0 512 512">
        <defs>
          <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="hotpink"/>
            <stop offset="100%" stop-color="red"/>
          </linearGradient>
        </defs>
        <path d="M256 472s-44-40-96-84C88 328 32 272 32 192 32 117 90 64 160 64c44 0 76 24 96 52 20-28 52-52 96-52 70 0 128 53 128 128 0 80-56 136-128 196-52 44-96 84-96 84z"/>
      </svg>
      <img src="./Prapose.png" id="proposalImg">
    </div>

    <!-- VIDEO PLAYER WITH CONTROLS -->
    <div id="proposalVideoContainer">
      <video id="proposalVideo" autoplay>
        <source src="./Message.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      
      <!-- Video Controls -->
      <div class="video-controls">
        <div class="controls-row">
          <button class="control-btn" id="playPauseBtn">
            <i class="fas fa-play"></i>
          </button>
          <button class="control-btn" id="replayBtn">
            <i class="fas fa-redo"></i>
          </button>
          <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
          <div class="volume-control">
            <button class="control-btn" id="volumeBtn" style="width: 36px; height: 36px;">
              <i class="fas fa-volume-up"></i>
            </button>
            <div class="volume-slider" id="volumeSlider">
              <div class="volume-slider-fill"></div>
              <div class="volume-slider-handle"></div>
            </div>
          </div>
        </div>
        <div class="controls-row">
          <div class="progress-container" id="progressContainer">
            <div id="videoProgress"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Continue Button (appears below video) -->
    <button id="continueAfterVideo">
      <i class="fas fa-heart"></i> Continue to Proposal
    </button>

    <div id="ring"></div>
    <button id="closeBtn">Unfold My Heart ‚ù§Ô∏è</button>
  </div>
</div>

<!-- CELEBRATION SCREEN -->
<div id="celebrationScreen">
  <div class="celebrationContent">
    <div style="font-size:3rem; margin-bottom:20px; animation:heartBeat 1s infinite;">üéâüíñüíç</div>
    <h2 style="font-family:'Great Vibes', cursive; font-size:3.0rem; color:hotpink; margin-bottom:20px;">
      Congratulations!
    </h2>
    <p style="color:#fff; font-size:1.2rem; line-height:1.6; margin-bottom:30px;">
      You have made me the happiest person in the world!<br>
      Our journey together as fianc√©s begins now...<br>
      I can't wait to spend forever with you! ‚ù§Ô∏è
    </p>
    <button id="finalJourneyBtn" style="margin-top:20px; padding:12px 30px; border:none; border-radius:25px; background:linear-gradient(45deg, gold, hotpink); color:white; font-size:1rem; cursor:pointer; box-shadow:0 0 20px gold;">
      Start Our Journey Together
    </button>
  </div>
</div>

<script>
// --- BACKGROUND AUDIO ---
const backgroundAudio = new Audio("https://github.com/princeprajapati106/Forever-Yours/raw/main/Sound.mp3");
backgroundAudio.loop = true;
backgroundAudio.volume = 1;
backgroundAudio.volume = 0.5;
let isAudioPlaying = false;

// Function to play background audio (ONLY for Final Proposal step)
function playBackgroundAudio() {
  if (!isAudioPlaying && step === 3) { // ‡§ï‡•á‡§µ‡§≤ Final Proposal step ‡§Æ‡•á‡§Ç
    backgroundAudio.currentTime = 0;
    backgroundAudio.play().then(() => {
      isAudioPlaying = true;
      console.log("Background audio started playing in Final Proposal step");
    }).catch(error => {
      console.log("Audio play failed:", error);
    });
  }
}

// Function to stop background audio
function stopBackgroundAudio() {
  if (isAudioPlaying) {
    backgroundAudio.pause();
    backgroundAudio.currentTime = 0;
    isAudioPlaying = false;
    console.log("Background audio stopped");
  }
}

// --- CANVAS PARTICLES ---
const canvas=document.querySelector("canvas");
const c=canvas.getContext("2d");
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
resize(); addEventListener("resize", resize);

class Particle {
  constructor(x,y,dx,dy,color){ this.x=x; this.y=y; this.dx=dx; this.dy=dy; this.life=1; this.color=color; }
  update(){ this.x+=this.dx; this.y+=this.dy; this.dy+=0.02; this.life-=0.01;
    c.beginPath(); c.arc(this.x,this.y,2,0,Math.PI*2); c.fillStyle=this.color;
    c.shadowBlur=15; c.shadowColor=this.color; c.fill();
  }
}

let particles=[];
function explode(x,y){
  const colors=["#ff4d6d","#ffb3c6","#fff"];
  for(let i=0;i<40;i++){
    const a=Math.random()*Math.PI*2;
    const s=Math.random()*4;
    particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,colors[Math.floor(Math.random()*3)]));
  }
}

function animate(){
  requestAnimationFrame(animate);
  c.fillStyle="rgba(0,0,0,0.25)";
  c.fillRect(0,0,canvas.width,canvas.height);
  if(Math.random()<0.05) explode(Math.random()*canvas.width,Math.random()*canvas.height*0.6);
  particles.forEach((p,i)=>{ p.update(); if(p.life<=0) particles.splice(i,1); });
}
animate();

// --- MAIN TYPEWRITER ---
const textEl=document.getElementById("text");
const heartEl=document.getElementById("heart");
const btn=document.getElementById("storyBtn");
const lines=[
  "My Dearest Anjali,",
  "I Love You More Than Words Can Say ‚ù§Ô∏è",
  "You Are My Forever",
  "Will You Marry Me? üíç",
  "‚ù§Ô∏è"
];
let l=0,ch=0,out="";
function typeMain(){
  if(ch<lines[l].length){ out+=lines[l][ch++]; textEl.innerHTML=out; setTimeout(typeMain,120); }
  else { out+="\n"; l++; ch=0; if(l<lines.length) setTimeout(typeMain,700);
    else { heartEl.style.opacity=1; btn.style.opacity=1; }
  }
}
setTimeout(typeMain,1000);

// --- VIDEO CONTROLS LOGIC ---
const video = document.getElementById('proposalVideo');
const playPauseBtn = document.getElementById('playPauseBtn');
const replayBtn = document.getElementById('replayBtn');
const volumeBtn = document.getElementById('volumeBtn');
const volumeSlider = document.getElementById('volumeSlider');
const progressBar = document.getElementById('videoProgress');
const progressContainer = document.getElementById('progressContainer');
const timeDisplay = document.getElementById('timeDisplay');
const continueAfterVideo = document.getElementById('continueAfterVideo');

let isVideoPlaying = false;
let isMuted = false;
let lastVolume = 1;

// Format time (seconds to mm:ss)
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// Update progress bar and time display
function updateVideoProgress() {
  if (video.duration) {
    const progressPercent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = `${progressPercent}%`;
    
    // Update time display
    timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
  }
}

// Update volume slider
function updateVolumeSlider() {
  const volumeFill = volumeSlider.querySelector('.volume-slider-fill');
  volumeFill.style.width = `${video.volume * 100}%`;
  
  const volumeHandle = volumeSlider.querySelector('.volume-slider-handle');
  volumeHandle.style.right = `${100 - (video.volume * 100)}%`;
}

// Play/Pause toggle
playPauseBtn.addEventListener('click', () => {
  if (video.paused) {
    video.play();
    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    isVideoPlaying = true;
  } else {
    video.pause();
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    isVideoPlaying = false;
  }
});

// Replay button
replayBtn.addEventListener('click', () => {
  video.currentTime = 0;
  video.play();
  playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
  isVideoPlaying = true;
  continueAfterVideo.classList.remove('enabled');
  continueAfterVideo.disabled = true;
});

// Volume button
volumeBtn.addEventListener('click', () => {
  if (isMuted) {
    video.volume = lastVolume;
    volumeBtn.innerHTML = video.volume > 0.5 ? '<i class="fas fa-volume-up"></i>' : 
                         video.volume > 0 ? '<i class="fas fa-volume-down"></i>' : 
                         '<i class="fas fa-volume-mute"></i>';
    isMuted = false;
  } else {
    lastVolume = video.volume;
    video.volume = 0;
    volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
    isMuted = true;
  }
  updateVolumeSlider();
});

// Volume slider
volumeSlider.addEventListener('click', (e) => {
  const rect = volumeSlider.getBoundingClientRect();
  const pos = (e.clientX - rect.left) / rect.width;
  const volume = Math.max(0, Math.min(1, pos));
  
  video.volume = volume;
  lastVolume = volume;
  isMuted = volume === 0;
  
  volumeBtn.innerHTML = volume > 0.5 ? '<i class="fas fa-volume-up"></i>' : 
                       volume > 0 ? '<i class="fas fa-volume-down"></i>' : 
                       '<i class="fas fa-volume-mute"></i>';
  
  updateVolumeSlider();
});

// Progress bar click to seek
progressContainer.addEventListener('click', (e) => {
  const rect = progressContainer.getBoundingClientRect();
  const pos = (e.clientX - rect.left) / rect.width;
  video.currentTime = pos * video.duration;
});

// Video events
video.addEventListener('timeupdate', updateVideoProgress);

video.addEventListener('loadedmetadata', () => {
  timeDisplay.textContent = `0:00 / ${formatTime(video.duration)}`;
  updateVolumeSlider();
});

video.addEventListener('volumechange', () => {
  updateVolumeSlider();
});

video.addEventListener('ended', () => {
  playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
  isVideoPlaying = false;
  // Enable continue button
  continueAfterVideo.classList.add('enabled');
  continueAfterVideo.disabled = false;
  continueAfterVideo.style.display = 'block';
});

// Continue button click
continueAfterVideo.addEventListener('click', () => {
  if (!continueAfterVideo.disabled) {
    videoContainer.style.display = 'none';
    continueAfterVideo.style.display = 'none';
    
    // Show final proposal
    heading.textContent="Final Proposal";
    heartWrap.style.display="block";
    ring.style.display="block";
    ring.innerHTML = "üíç";
    
    // Remove scrollbar for final proposal
    popupText.classList.remove('long-message');
    
    const proposalText = `This ring symbolizes a journey‚Äî
            not just of romance, but partnership,
            growth, and a love that grows deeper with time.

            I can't imagine my future without you in it.
            Will you be my wife? üíñüíç`;
    typeText(proposalText);
    currentFullText = proposalText;
    closeBtn.style.display = "block";
    closeBtn.textContent="üíñ Yes, I Will! üíñ";
    
    // Update step to final proposal step
    step = 3;
    
    // ‚úÖ AUDIO: Play ONLY in Final Proposal step
    // ‡§•‡•ã‡§°‡§º‡§æ delay ‡§¶‡•á‡§ï‡§∞ audio play ‡§ï‡§∞‡•á‡§Ç
    setTimeout(() => {
      playBackgroundAudio();
    }, 500);
  }
});

// --- POPUP LOGIC ---
const popup=document.getElementById("popup");
const heading=document.getElementById("popupHeading");
const popupText=document.getElementById("popupText");
const ring=document.getElementById("ring");
const closeBtn=document.getElementById("closeBtn");
const heartWrap=document.getElementById("heartWrap");
const videoContainer = document.getElementById("proposalVideoContainer");
const celebrationScreen=document.getElementById("celebrationScreen");
const finalJourneyBtn=document.getElementById("finalJourneyBtn");

let step=0;
let isTyping = false;
let typeTimeout = null;
let currentFullText = "";

btn.onclick=()=> popup.style.display="flex";

// MAIN CLOSE BUTTON CLICK HANDLER
closeBtn.onclick = () => {
  // Cancel any ongoing typing
  if (isTyping) {
    isTyping = false;
    if (typeTimeout) clearTimeout(typeTimeout);
    popupText.textContent = currentFullText;
    popupText.scrollTop = popupText.scrollHeight;
  }
  
  ring.style.display="none";
  heartWrap.style.display="none";
  videoContainer.style.display = "none";
  continueAfterVideo.style.display = "none";
  
  // ‚úÖ AUDIO: Stop when moving away from Final Proposal
  if (step === 3) {
    stopBackgroundAudio();
  }

  if(step===0){
    heading.textContent = "I Want To Share Something Special";
    // Long message with scrollbar
    const longMessage = `Hi Anjali,

        Mujhe pata hai ki Shadi decision bilkul bhi aasan nahi hai. 
        Ye aapki life ka bahut bada faisla hai, aur main is baat ko poori tarah samajhta hoon.

        Main aapse ye sab call par kehna chahta tha, lekin baat ho nahi pa rahi thi,
        isliye mujhe laga ki likh kar apni baat rakhna zyada behtar rahega.

        Main bas itna kehna chahta hoon ki agar aapko decision lene mein kisi bhi tarah ki 
        confusion ya dikkat ho rahi hai, to aap mujhse bilkul khul kar share kar sakti ho. 
        Hum milkar har cheez ka solution nikaal sakte hain. Main hamesha aapke saath khada hoon.

        Agar aapko ye lagta hai ki meri family mein aane par aapko kaisa lagega,
        to main poori zimmedari ke saath keh sakta hoon ki aapko hamare parivaar mein 
        adjust hone mein koi problem nahi hogi. Hamare ghar mein koi restriction nahi hai‚Äî
        sab log pyaar aur khushi se rehte hain.

        Aur agar phir bhi aapke mann mein koi doubt ho,
        to main aapki baat apni mummy se bhi karwa sakta hoon.
        Shayad wo mujhse bhi behtar tareeke se aapko aur mere parivaar ko samjha paayengi.

        Agar aap ye soch rahi ho ki aapke bhai ya mummy kya sochenge,
        to uski bhi zimmedari main leta hoon. Mujhe poora vishwas hai ki main sab ko mana lunga 
        or abhi log waqt aane par khushi-khushi hamari shaadi ko accept karenge.

        Aur main puri koshish karunga ki aapke ghar walon ko manane ki‚Äîwo zimmedari main khud leta hoon.
        Usme aapko koi kuch nahi bolenga kabhi bhi.
        Aur aapke "HAA" ka decision‚Äîaapki life ka sabse sahi aur pyara decision banane ki puri koshish karunga.

        Main aapki situation, aapki zimmedariyaan aur aapki feelings ko samajhta hoon.
        Aapke parents mere parents jaise hi hain, aur main kabhi bhi kisi bhi tarah ki takleef 
        unhe ya aapko aane nahi dunga. Ye mera promise hai.

        Agar aap abhi shaadi ke liye ready nahi ho aur kuch saal baad karna chahti ho,
        to main uske liye bhi poori tarah ready hoon.

        Mujhe bas aapse itni si clarity chahiye ki aapke mann mein kya chal raha hai,
        ya phir aapko aur thoda time chahiye.
        Kyunki mere liye aap aur ye moment dono bahut important hain.

        Shayad upar wala bhi yahi chahta tha.
        Meri kuch unhealthy behaviour ki wajah se aapko kaafi hurt hua‚Äî
        wo sab bachpana tha, galtiyan thi.
        Jab mujhe samajh aaya ki is relationship ko space aur sukoon chahiye,
        to meri bas ek hi chahat thi‚Äîaapka sukoon aur aapki khushi.

        Isliye maine sab bhagwan par chhod diya tha.
        Agar unki marzi hogi, to hum phir milenge‚Ä¶ aur hum mile‚Äî
        pehle se zyada behtar tareeke se.

        8 saal ho gaye hain, aur aaj bhi main aapke liye wahi khada hoon.

        Aur agar aap ko lagta hai ki ye sab baatein mujhe saath baith ke karni chahiye,
        to aap bata dijiye ki aap kab free hai‚Äîto main us din aa jaunga Pune,
        ya phir Holi mein Gove mein milna hai, jaisa aap ko sahi lage.

        Aur mujhe lagta hai ki agar aap kisi aur se shaadi karte hai bina jaane,
        to vo aapko kaisa treat karega?
        Aap hamein jaante ho aur hamare pariwar ko bhi‚Äî
        yahan aapko easy feel hoga, aur sab aapko khushi-khushi accept karenge.
        Aapko hamare yahan koi bhi restriction nahi feel hogi‚Äîye promise main deta hoon.

        Ab wo waqt aa gaya hai jab mujhe apne dil ki baat aapse kehni thi.
        Main aapse abhi koi jawab ya decision nahi maang raha hoon‚Äî
        mujhe bas itni si clarity chahiye ki aapko thoda aur time chahiye 
        ya aap kya feel kar rahi ho.

        Bas itna hi.`;
    
    // Add scrollbar styling for this long message only
    popupText.classList.add('long-message');
    
    typeText(longMessage);
    currentFullText = longMessage;
    closeBtn.textContent="üíï Continue";
    step++;
  } else if(step===1){
    // STEP 2: SHOW VIDEO PLAYER
    heading.textContent="A Special Video for You";
    popupText.textContent = "Before the final proposal, please watch this special video message from my heart... ‚ù§Ô∏è";
    
    // Remove scrollbar for video message
    popupText.classList.remove('long-message');
    
    // Hide previous elements
    heartWrap.style.display="none";
    ring.style.display="none";
    
    // Show video player
    videoContainer.style.display = "block";
    closeBtn.style.display = "none"; // Hide the main close button
    
    // Reset video
    video.currentTime = 0;
    video.pause();
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    isVideoPlaying = false;
    
    // Reset continue button
    continueAfterVideo.classList.remove('enabled');
    continueAfterVideo.disabled = true;
    continueAfterVideo.style.display = 'block';
    
    step++; // Move to next step (video watching step)
  } else if(step===2){
    // STEP 3: SHOW FINAL PROPOSAL
    if (!video.ended) {
      // If video hasn't ended, show message
      alert("Please watch the video first to continue...");
      return;
    }
    
    // This should now be handled by the continueAfterVideo button
    // So we shouldn't reach here directly
  } else if(step===3){
    // Accept button clicked - show celebration screen directly
    popup.style.display="none";
    celebrationScreen.style.display="flex";
    
    // Create celebration particles
    for(let i=0; i<30; i++){
      setTimeout(() => {
        explode(Math.random()*window.innerWidth, Math.random()*window.innerHeight);
      }, i*100);
    }
  }
};

// --- TYPEWRITER FOR POPUP ---
function typeText(msg){
  currentFullText = msg;
  popupText.textContent="";
  let i=0;
  isTyping = true;
  
  (function t(){
    if(i<msg.length && isTyping){
      popupText.textContent+=msg[i++];
      popupText.scrollTop = popupText.scrollHeight;
      typeTimeout = setTimeout(t, 50);
    } else {
      isTyping = false;
    }
  })();
}

// --- FINAL JOURNEY BUTTON ---
finalJourneyBtn.onclick = () => {
  // ‚úÖ AUDIO: Stop when moving to final message
  stopBackgroundAudio();
  
  celebrationScreen.style.display = "none";
  
  // Create final celebration with more particles
  for(let i=0; i<50; i++){
    setTimeout(() => {
      explode(Math.random()*window.innerWidth, Math.random()*window.innerHeight);
    }, i*80);
  }
  
  // Show final message with CALL BUTTON
  const finalMsg = document.createElement("div");
  finalMsg.className = "final-message-overlay";
  finalMsg.innerHTML = `
    <div class="final-message-content">
      <h2>Our Journey Begins!</h2>
      <p style="margin-bottom:25px; line-height:1.6;">
        From this moment forward, we walk hand in hand through life's adventures.<br>
        Thank you for saying YES! ‚ù§Ô∏èüíç
      </p>
      <a href="tel:8853515454" class="call-button" style="margin-right:10px;">
        Forever Yours üìû
      </a>
    </div> 
  `;
  document.body.appendChild(finalMsg);
};

// Auto-play audio on user interaction (for browser policies)
document.addEventListener('click', function initAudio() {
  // Preload the audio
  backgroundAudio.load();
  document.removeEventListener('click', initAudio);
});
</script>

</body>
</html>